name: Build and Test ZeroTrust-FLBench

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: false
        tags: zerotrust-fl:test
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Save Docker image
      run: docker save zerotrust-fl:test | gzip > zerotrust-fl-image.tar.gz
      
    - name: Upload Docker image artifact
      uses: actions/upload-artifact@v4
      with:
        name: docker-image
        path: zerotrust-fl-image.tar.gz
        retention-days: 1

  test-local:
    name: Test FL Code Locally
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        pip install flwr torch torchvision numpy
        
    - name: Run local FL test
      run: |
        python3 test_fl_locally.py
        
    - name: Check test results
      run: |
        echo "✅ FL code test completed"

  validate-manifests:
    name: Validate Kubernetes Manifests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install kubeval
      run: |
        wget https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
        tar xf kubeval-linux-amd64.tar.gz
        sudo mv kubeval /usr/local/bin
        
    - name: Validate baseline manifests
      run: |
        kubeval k8s/00-baseline/fl-deployment.yaml --ignore-missing-schemas
        
    - name: Validate NetworkPolicy manifests
      run: |
        kubeval k8s/10-networkpolicy/fl-deployment.yaml --ignore-missing-schemas
        kubeval k8s/10-networkpolicy/networkpolicies.yaml --ignore-missing-schemas
        
    - name: Validate mTLS manifests
      run: |
        kubeval k8s/20-mtls/fl-deployment.yaml --ignore-missing-schemas

  lint-python:
    name: Lint Python Code
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install flake8
      run: pip install flake8
        
    - name: Lint with flake8
      run: |
        # Stop on syntax errors
        flake8 src/ scripts/ --count --select=E9,F63,F7,F82 --show-source --statistics
        # Check for other issues
        flake8 src/ scripts/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

  check-paper:
    name: Compile LaTeX Paper
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Compile LaTeX document
      uses: xu-cheng/latex-action@v3
      with:
        root_file: zerotrust_fl_paper.tex
        work_in_root_file_dir: true
        
    - name: Upload PDF
      uses: actions/upload-artifact@v4
      with:
        name: paper-pdf
        path: zerotrust_fl_paper.pdf
        retention-days: 7

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [build, test-local, validate-manifests, lint-python, check-paper]
    if: always()
    
    steps:
    - name: Check results
      run: |
        echo "## Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Docker build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Local FL test: ${{ needs.test-local.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ K8s manifests: ${{ needs.validate-manifests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ Python lint: ${{ needs.lint-python.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- ✅ LaTeX paper: ${{ needs.check-paper.result }}" >> $GITHUB_STEP_SUMMARY
