---
# Namespace for baseline FL experiments (SEC0)
apiVersion: v1
kind: Namespace
metadata:
  name: fl-experiment
  labels:
    security-level: sec0
---
# Service for FL Server
apiVersion: v1
kind: Service
metadata:
  name: fl-server
  namespace: fl-experiment
  labels:
    app: fl-server
    run-id: "PLACEHOLDER"
spec:
  type: ClusterIP
  ports:
  - port: 8080
    targetPort: 8080
    protocol: TCP
    name: grpc
  selector:
    app: fl-server
---
# Deployment for FL Server
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fl-server
  namespace: fl-experiment
  labels:
    app: fl-server
    run-id: "PLACEHOLDER"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: fl-server
  template:
    metadata:
      labels:
        app: fl-server
        run-id: "PLACEHOLDER"  # FIX: Will be replaced by run script
    spec:
      containers:
      - name: fl-server
        image: zerotrust-flbench:latest
        imagePullPolicy: IfNotPresent
        command: ["python", "/app/src/fl_server.py"]
        args:
          - "--num-rounds=10"
          - "--min-clients=5"
          - "--fraction-fit=1.0"
          - "--server-address=0.0.0.0:8080"
        ports:
        - containerPort: 8080
          name: grpc
        env:
        - name: RUN_ID
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['run-id']  # FIX: Now label exists
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "2000m"
        volumeMounts:
        - name: data
          mountPath: /data
      volumes:
      - name: data
        emptyDir: {}
---
# Job for FL Client 1
apiVersion: batch/v1
kind: Job
metadata:
  name: fl-client-1
  namespace: fl-experiment
  labels:
    app: fl-client
    client-id: "1"
    run-id: "PLACEHOLDER"
spec:
  backoffLimit: 0
  template:
    metadata:
      labels:
        app: fl-client
        client-id: "1"
        run-id: "PLACEHOLDER"  # FIX: Will be replaced by run script
    spec:
      restartPolicy: Never
      containers:
      - name: fl-client
        image: zerotrust-flbench:latest
        imagePullPolicy: IfNotPresent
        command: ["python", "/app/src/fl_client.py"]
        args:
          - "--client-id=1"
          - "--num-clients=5"
          - "--server-address=fl-server:8080"
          - "--iid"
          - "--data-seed=42"
        env:
        - name: RUN_ID
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['run-id']  # FIX: Now label exists
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
        volumeMounts:
        - name: data
          mountPath: /data
      volumes:
      - name: data
        emptyDir: {}
---
# Job for FL Client 2
apiVersion: batch/v1
kind: Job
metadata:
  name: fl-client-2
  namespace: fl-experiment
  labels:
    app: fl-client
    client-id: "2"
    run-id: "PLACEHOLDER"
spec:
  backoffLimit: 0
  template:
    metadata:
      labels:
        app: fl-client
        client-id: "2"
        run-id: "PLACEHOLDER"  # FIX: Will be replaced by run script
    spec:
      restartPolicy: Never
      containers:
      - name: fl-client
        image: zerotrust-flbench:latest
        imagePullPolicy: IfNotPresent
        command: ["python", "/app/src/fl_client.py"]
        args:
          - "--client-id=2"
          - "--num-clients=5"
          - "--server-address=fl-server:8080"
          - "--iid"
          - "--data-seed=42"
        env:
        - name: RUN_ID
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['run-id']  # FIX: Now label exists
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
        volumeMounts:
        - name: data
          mountPath: /data
      volumes:
      - name: data
        emptyDir: {}
---
# Job for FL Client 3
apiVersion: batch/v1
kind: Job
metadata:
  name: fl-client-3
  namespace: fl-experiment
  labels:
    app: fl-client
    client-id: "3"
    run-id: "PLACEHOLDER"
spec:
  backoffLimit: 0
  template:
    metadata:
      labels:
        app: fl-client
        client-id: "3"
        run-id: "PLACEHOLDER"  # FIX: Will be replaced by run script
    spec:
      restartPolicy: Never
      containers:
      - name: fl-client
        image: zerotrust-flbench:latest
        imagePullPolicy: IfNotPresent
        command: ["python", "/app/src/fl_client.py"]
        args:
          - "--client-id=3"
          - "--num-clients=5"
          - "--server-address=fl-server:8080"
          - "--iid"
          - "--data-seed=42"
        env:
        - name: RUN_ID
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['run-id']  # FIX: Now label exists
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
        volumeMounts:
        - name: data
          mountPath: /data
      volumes:
      - name: data
        emptyDir: {}
---
# Job for FL Client 4
apiVersion: batch/v1
kind: Job
metadata:
  name: fl-client-4
  namespace: fl-experiment
  labels:
    app: fl-client
    client-id: "4"
    run-id: "PLACEHOLDER"
spec:
  backoffLimit: 0
  template:
    metadata:
      labels:
        app: fl-client
        client-id: "4"
        run-id: "PLACEHOLDER"  # FIX: Will be replaced by run script
    spec:
      restartPolicy: Never
      containers:
      - name: fl-client
        image: zerotrust-flbench:latest
        imagePullPolicy: IfNotPresent
        command: ["python", "/app/src/fl_client.py"]
        args:
          - "--client-id=4"
          - "--num-clients=5"
          - "--server-address=fl-server:8080"
          - "--iid"
          - "--data-seed=42"
        env:
        - name: RUN_ID
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['run-id']  # FIX: Now label exists
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
        volumeMounts:
        - name: data
          mountPath: /data
      volumes:
      - name: data
        emptyDir: {}
---
# Job for FL Client 5
apiVersion: batch/v1
kind: Job
metadata:
  name: fl-client-5
  namespace: fl-experiment
  labels:
    app: fl-client
    client-id: "5"
    run-id: "PLACEHOLDER"
spec:
  backoffLimit: 0
  template:
    metadata:
      labels:
        app: fl-client
        client-id: "5"
        run-id: "PLACEHOLDER"  # FIX: Will be replaced by run script
    spec:
      restartPolicy: Never
      containers:
      - name: fl-client
        image: zerotrust-flbench:latest
        imagePullPolicy: IfNotPresent
        command: ["python", "/app/src/fl_client.py"]
        args:
          - "--client-id=5"
          - "--num-clients=5"
          - "--server-address=fl-server:8080"
          - "--iid"
          - "--data-seed=42"
        env:
        - name: RUN_ID
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['run-id']  # FIX: Now label exists
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
        volumeMounts:
        - name: data
          mountPath: /data
      volumes:
      - name: data
        emptyDir: {}
