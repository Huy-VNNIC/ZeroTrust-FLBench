---
apiVersion: v1
kind: Namespace
metadata:
  name: fl-experiment
  labels:
    security-config: SEC0
    network-profile: NET0
---
apiVersion: v1
kind: Service
metadata:
  name: fl-server
  namespace: fl-experiment
spec:
  selector:
    app: fl-server
  ports:
    - name: grpc
      protocol: TCP
      port: 8080
      targetPort: 8080
  type: ClusterIP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fl-server
  namespace: fl-experiment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: fl-server
  template:
    metadata:
      labels:
        app: fl-server
        run-id: "PLACEHOLDER"  # Will be replaced by run script
        component: server
    spec:
      containers:
      - name: fl-server
        image: zerotrust-flbench:latest
        imagePullPolicy: IfNotPresent
        command: ["python", "/app/src/fl_server.py"]
        args:
          - "--num-rounds=50"
          - "--min-clients=5"
          - "--fraction-fit=1.0"
          - "--server-address=0.0.0.0:8080"
        ports:
        - containerPort: 8080
          name: grpc
        env:
        - name: RUN_ID
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['run-id']
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "2Gi"
            cpu: "2000m"
        volumeMounts:
        - name: data
          mountPath: /data
      volumes:
      - name: data
        emptyDir: {}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: fl-client-0
  namespace: fl-experiment
spec:
  backoffLimit: 0
  template:
    metadata:
      labels:
        app: fl-client
        client-id: "0"
    spec:
      restartPolicy: Never
      containers:
      - name: fl-client
        image: zerotrust-flbench:latest
        imagePullPolicy: IfNotPresent
        command: ["python", "/app/src/fl_client.py"]
        args:
          - "--client-id=0"
          - "--num-clients=5"
          - "--server-address=fl-server:8080"
          - "--iid"
        env:
        - name: RUN_ID
          valueFrom:
            fieldRef:
              fieldPath: metadata.labels['run-id']
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
        volumeMounts:
        - name: data
          mountPath: /data
      volumes:
      - name: data
        emptyDir: {}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: fl-client-1
  namespace: fl-experiment
spec:
  backoffLimit: 0
  template:
    metadata:
      labels:
        app: fl-client
        client-id: "1"
        run-id: "PLACEHOLDER"  # Will be replaced by run script
    spec:
      restartPolicy: Never
      containers:
      - name: fl-client
        image: zerotrust-flbench:latest
        imagePullPolicy: IfNotPresent
        command: ["python", "/app/src/fl_client.py"]
        args:
          - "--client-id=1"
          - "--num-clients=5"
          - "--server-address=fl-server:8080"
          - "--iid"
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
        volumeMounts:
        - name: data
          mountPath: /data
      volumes:
      - name: data
        emptyDir: {}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: fl-client-2
  namespace: fl-experiment
spec:
  backoffLimit: 0
  template:
    metadata:
      labels:
        app: fl-client
        client-id: "2"
    spec:
      restartPolicy: Never
      containers:
      - name: fl-client
        image: zerotrust-flbench:latest
        imagePullPolicy: IfNotPresent
        command: ["python", "/app/src/fl_client.py"]
        args:
          - "--client-id=2"
          - "--num-clients=5"
          - "--server-address=fl-server:8080"
          - "--iid"
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
        volumeMounts:
        - name: data
          mountPath: /data
      volumes:
      - name: data
        emptyDir: {}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: fl-client-3
  namespace: fl-experiment
spec:
  backoffLimit: 0
  template:
    metadata:
      labels:
        app: fl-client
        client-id: "3"
    spec:
      restartPolicy: Never
      containers:
      - name: fl-client
        image: zerotrust-flbench:latest
        imagePullPolicy: IfNotPresent
        command: ["python", "/app/src/fl_client.py"]
        args:
          - "--client-id=3"
          - "--num-clients=5"
          - "--server-address=fl-server:8080"
          - "--iid"
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
        volumeMounts:
        - name: data
          mountPath: /data
      volumes:
      - name: data
        emptyDir: {}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: fl-client-4
  namespace: fl-experiment
spec:
  backoffLimit: 0
  template:
    metadata:
      labels:
        app: fl-client
        client-id: "4"
    spec:
      restartPolicy: Never
      containers:
      - name: fl-client
        image: zerotrust-flbench:latest
        imagePullPolicy: IfNotPresent
        command: ["python", "/app/src/fl_client.py"]
        args:
          - "--client-id=4"
          - "--num-clients=5"
          - "--server-address=fl-server:8080"
          - "--iid"
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
        volumeMounts:
        - name: data
          mountPath: /data
      volumes:
      - name: data
        emptyDir: {}
